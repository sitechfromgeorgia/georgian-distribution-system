-- 1. Check if orders exists
DO $$
BEGIN
    IF NOT EXISTS (SELECT FROM pg_tables WHERE schemaname = 'public' AND tablename = 'orders') THEN
        RAISE EXCEPTION 'Table public.orders does not exist! Please run initial_schema.sql first.';
    END IF;
END $$;

-- 2. Create order_comments
CREATE TABLE IF NOT EXISTS public.order_comments (
  id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
  order_id uuid REFERENCES public.orders(id) ON DELETE CASCADE,
  author_id uuid REFERENCES public.profiles(id) ON DELETE CASCADE,
  comment_text text NOT NULL,
  comment_type text DEFAULT 'general' CHECK (comment_type IN ('general', 'issue', 'praise')),
  created_at timestamptz DEFAULT now(),
  updated_at timestamptz DEFAULT now()
);

ALTER TABLE public.order_comments ENABLE ROW LEVEL SECURITY;

CREATE INDEX IF NOT EXISTS idx_order_comments_order ON public.order_comments(order_id, created_at DESC);

DO $$ BEGIN
  CREATE POLICY "Restaurants can view own order comments" ON public.order_comments FOR SELECT USING ((auth.jwt() ->> 'role')::text = 'restaurant' AND order_id IN (SELECT id FROM public.orders WHERE restaurant_id = auth.uid()));
EXCEPTION WHEN duplicate_object THEN NULL; END $$;

DO $$ BEGIN
  CREATE POLICY "Restaurants can insert own order comments" ON public.order_comments FOR INSERT WITH CHECK ((auth.jwt() ->> 'role')::text = 'restaurant' AND order_id IN (SELECT id FROM public.orders WHERE restaurant_id = auth.uid()) AND author_id = auth.uid());
EXCEPTION WHEN duplicate_object THEN NULL; END $$;

DO $$ BEGIN
  CREATE POLICY "Admins can view all order comments" ON public.order_comments FOR SELECT USING ((auth.jwt() ->> 'role')::text = 'admin' OR EXISTS (SELECT 1 FROM public.profiles WHERE id = auth.uid() AND role = 'admin'));
EXCEPTION WHEN duplicate_object THEN NULL; END $$;

DO $$ BEGIN
  CREATE POLICY "Admins can insert comments" ON public.order_comments FOR INSERT WITH CHECK ((auth.jwt() ->> 'role')::text = 'admin' OR EXISTS (SELECT 1 FROM public.profiles WHERE id = auth.uid() AND role = 'admin'));
EXCEPTION WHEN duplicate_object THEN NULL; END $$;


-- 3. Create cart_snapshots
CREATE TABLE IF NOT EXISTS public.cart_snapshots (
  id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
  restaurant_id uuid REFERENCES public.profiles(id) ON DELETE CASCADE,
  product_id uuid REFERENCES public.products(id) ON DELETE CASCADE,
  quantity integer NOT NULL CHECK (quantity > 0),
  created_at timestamptz DEFAULT now(),
  updated_at timestamptz DEFAULT now(),
  UNIQUE(restaurant_id, product_id)
);

ALTER TABLE public.cart_snapshots ENABLE ROW LEVEL SECURITY;

CREATE INDEX IF NOT EXISTS idx_cart_snapshots_restaurant ON public.cart_snapshots(restaurant_id);

DO $$ BEGIN
  CREATE POLICY "Restaurants can manage own cart" ON public.cart_snapshots FOR ALL USING ((auth.jwt() ->> 'role')::text = 'restaurant' AND restaurant_id = auth.uid());
EXCEPTION WHEN duplicate_object THEN NULL; END $$;
