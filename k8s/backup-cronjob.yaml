apiVersion: batch/v1
kind: CronJob
metadata:
  name: database-backup
  namespace: georgian-distribution
spec:
  # Run daily at 2 AM
  schedule: "0 2 * * *"
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  concurrencyPolicy: Forbid
  jobTemplate:
    spec:
      template:
        metadata:
          labels:
            app: database-backup
        spec:
          restartPolicy: OnFailure
          containers:
          - name: backup
            image: postgres:16-alpine
            command:
            - /bin/sh
            - -c
            - |
              #!/bin/sh
              set -e

              TIMESTAMP=$(date +%Y%m%d_%H%M%S)
              BACKUP_FILE="/backups/backup_${TIMESTAMP}.sql"

              echo "Creating database backup..."
              pg_dump \
                --host="$DB_HOST" \
                --port="5432" \
                --username="$DB_USER" \
                --dbname="postgres" \
                --format=plain \
                --no-owner \
                --no-acl \
                --clean \
                --if-exists \
                --file="$BACKUP_FILE"

              echo "Compressing backup..."
              gzip "$BACKUP_FILE"

              echo "Backup complete: ${BACKUP_FILE}.gz"

              # Upload to S3 if configured
              if [ -n "$S3_BUCKET" ]; then
                echo "Uploading to S3..."
                apk add --no-cache aws-cli
                aws s3 cp "${BACKUP_FILE}.gz" \
                  "s3://$S3_BUCKET/backups/$(basename ${BACKUP_FILE}.gz)"
              fi

              # Clean up old backups
              find /backups -name "backup_*.sql.gz" -type f -mtime +7 -delete
              echo "Old backups cleaned up"
            env:
            - name: DB_HOST
              valueFrom:
                secretKeyRef:
                  name: app-secrets
                  key: NEXT_PUBLIC_SUPABASE_URL
            - name: DB_USER
              value: "postgres"
            - name: PGPASSWORD
              valueFrom:
                secretKeyRef:
                  name: app-secrets
                  key: SUPABASE_DB_PASSWORD
            - name: S3_BUCKET
              value: "georgian-distribution-backups"
            - name: AWS_ACCESS_KEY_ID
              valueFrom:
                secretKeyRef:
                  name: app-secrets
                  key: AWS_ACCESS_KEY_ID
                  optional: true
            - name: AWS_SECRET_ACCESS_KEY
              valueFrom:
                secretKeyRef:
                  name: app-secrets
                  key: AWS_SECRET_ACCESS_KEY
                  optional: true
            - name: AWS_REGION
              value: "us-east-1"
            volumeMounts:
            - name: backups
              mountPath: /backups
            resources:
              requests:
                memory: "256Mi"
                cpu: "100m"
              limits:
                memory: "512Mi"
                cpu: "500m"
          volumes:
          - name: backups
            persistentVolumeClaim:
              claimName: database-backups-pvc
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: database-backups-pvc
  namespace: georgian-distribution
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 10Gi
  storageClassName: standard
