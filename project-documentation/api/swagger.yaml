openapi: 3.0.3
info:
  title: Distribution Management System API
  description: |
    Comprehensive API documentation for the Distribution Management System.

    ## Overview
    This system manages orders, products, and deliveries across restaurants, drivers, and administrators.

    ## Authentication
    All endpoints require authentication using Supabase JWT tokens.
    Include the token in the `Authorization` header:
    ```
    Authorization: Bearer <your_jwt_token>
    ```

    ## Base URL
    - Development: `http://localhost:3000`
    - Production: `https://your-domain.com`

    ## Rate Limiting
    - 100 requests per minute per user
    - 1000 requests per hour per user

    ## Error Handling
    All errors follow this format:
    ```json
    {
      "code": "ERROR_CODE",
      "message": "Human-readable error message",
      "details": {
        "field": "fieldName",
        "value": "invalidValue"
      }
    }
    ```

  version: 1.0.0
  contact:
    name: API Support
    email: support@example.com
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT

servers:
  - url: http://localhost:3000/api
    description: Development server
  - url: https://api.production.com
    description: Production server

tags:
  - name: Authentication
    description: User authentication and session management
  - name: Products
    description: Product catalog management
  - name: Orders
    description: Order creation and management
  - name: Users
    description: User profile management
  - name: Cart
    description: Shopping cart operations

security:
  - BearerAuth: []

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: Supabase JWT token

  schemas:
    # Authentication
    LoginRequest:
      type: object
      required:
        - email
        - password
      properties:
        email:
          type: string
          format: email
          example: restaurant@example.com
        password:
          type: string
          format: password
          minLength: 8
          example: SecurePass123!
        rememberMe:
          type: boolean
          default: false

    LoginResponse:
      type: object
      properties:
        user:
          $ref: '#/components/schemas/User'
        session:
          $ref: '#/components/schemas/Session'
        profile:
          $ref: '#/components/schemas/Profile'

    Session:
      type: object
      properties:
        access_token:
          type: string
        refresh_token:
          type: string
        expires_in:
          type: integer
          example: 18000
        expires_at:
          type: integer
          example: 1699564800

    User:
      type: object
      properties:
        id:
          type: string
          format: uuid
        email:
          type: string
          format: email
        role:
          type: string
          enum: [admin, restaurant, driver]

    # Profile
    Profile:
      type: object
      properties:
        id:
          type: string
          format: uuid
        fullName:
          type: string
          example: John Doe
        email:
          type: string
          format: email
        phone:
          type: string
          example: +995555123456
        avatarUrl:
          type: string
          format: uri
          nullable: true
        role:
          type: string
          enum: [admin, restaurant, driver]
        isActive:
          type: boolean
        isAvailable:
          type: boolean
        address:
          type: string
          nullable: true
        location:
          $ref: '#/components/schemas/Location'
        city:
          type: string
          nullable: true
        postalCode:
          type: string
          nullable: true
        vehicleType:
          type: string
          nullable: true
          example: sedan
        vehicleNumber:
          type: string
          nullable: true
          example: AB-123-CD
        vehicleInfo:
          $ref: '#/components/schemas/VehicleInfo'
        businessName:
          type: string
          nullable: true
        businessType:
          type: string
          nullable: true
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    VehicleInfo:
      type: object
      properties:
        make:
          type: string
          example: Toyota
        model:
          type: string
          example: Camry
        year:
          type: integer
          example: 2020
        color:
          type: string
          example: Silver
        capacity:
          type: string
          example: 500kg

    Location:
      type: object
      properties:
        lat:
          type: number
          format: float
          example: 41.7151
        lng:
          type: number
          format: float
          example: 44.8271

    # Products
    Product:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
          example: Product Name
        description:
          type: string
          nullable: true
        sku:
          type: string
          example: PROD-001
        price:
          type: number
          format: float
          example: 29.99
        categoryId:
          type: string
          format: uuid
        category:
          $ref: '#/components/schemas/Category'
        imageUrl:
          type: string
          format: uri
          nullable: true
        isAvailable:
          type: boolean
        stock:
          type: integer
          minimum: 0
        unit:
          type: string
          example: kg
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    Category:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
          example: Electronics
        slug:
          type: string
          example: electronics
        description:
          type: string
          nullable: true

    CreateProductRequest:
      type: object
      required:
        - name
        - price
        - categoryId
      properties:
        name:
          type: string
          minLength: 2
          maxLength: 255
        description:
          type: string
        sku:
          type: string
        price:
          type: number
          format: float
          minimum: 0
        categoryId:
          type: string
          format: uuid
        imageUrl:
          type: string
          format: uri
        isAvailable:
          type: boolean
          default: true
        stock:
          type: integer
          minimum: 0
        unit:
          type: string

    UpdateProductRequest:
      type: object
      properties:
        name:
          type: string
        description:
          type: string
        sku:
          type: string
        price:
          type: number
          format: float
          minimum: 0
        categoryId:
          type: string
          format: uuid
        imageUrl:
          type: string
          format: uri
        isAvailable:
          type: boolean
        stock:
          type: integer
          minimum: 0
        unit:
          type: string

    ProductListResponse:
      type: object
      properties:
        products:
          type: array
          items:
            $ref: '#/components/schemas/Product'
        pagination:
          $ref: '#/components/schemas/Pagination'

    # Orders
    Order:
      type: object
      properties:
        id:
          type: string
          format: uuid
        orderNumber:
          type: string
          example: ORD-1699564800-ABC123
        restaurantId:
          type: string
          format: uuid
        driverId:
          type: string
          format: uuid
          nullable: true
        status:
          type: string
          enum: [pending, confirmed, priced, assigned, picked_up, in_transit, delivered, cancelled]
        priority:
          type: string
          enum: [low, normal, high, urgent]
        subtotal:
          type: number
          format: float
        deliveryFee:
          type: number
          format: float
        discount:
          type: number
          format: float
          nullable: true
        totalAmount:
          type: number
          format: float
        deliveryAddress:
          type: string
        deliveryLocation:
          $ref: '#/components/schemas/Location'
        deliveryNotes:
          type: string
          nullable: true
        customerName:
          type: string
          nullable: true
        customerPhone:
          type: string
          nullable: true
        items:
          type: array
          items:
            $ref: '#/components/schemas/OrderItem'
        restaurant:
          $ref: '#/components/schemas/Profile'
        driver:
          $ref: '#/components/schemas/Profile'
        notes:
          type: string
          nullable: true
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    OrderItem:
      type: object
      properties:
        id:
          type: string
          format: uuid
        orderId:
          type: string
          format: uuid
        productId:
          type: string
          format: uuid
        productName:
          type: string
        productSku:
          type: string
          nullable: true
        quantity:
          type: integer
          minimum: 1
        unitPrice:
          type: number
          format: float
        totalPrice:
          type: number
          format: float
        notes:
          type: string
          nullable: true
        product:
          $ref: '#/components/schemas/Product'

    CreateOrderRequest:
      type: object
      required:
        - items
        - deliveryAddress
      properties:
        items:
          type: array
          minItems: 1
          items:
            type: object
            required:
              - productId
              - quantity
            properties:
              productId:
                type: string
                format: uuid
              quantity:
                type: integer
                minimum: 1
              notes:
                type: string
        deliveryAddress:
          type: string
          minLength: 10
        deliveryLocation:
          $ref: '#/components/schemas/Location'
        deliveryNotes:
          type: string
        customerName:
          type: string
        customerPhone:
          type: string
        notes:
          type: string
        priority:
          type: string
          enum: [low, normal, high, urgent]
          default: normal

    UpdateOrderStatusRequest:
      type: object
      required:
        - status
      properties:
        status:
          type: string
          enum: [confirmed, priced, assigned, picked_up, in_transit, delivered, cancelled]
        metadata:
          type: object
          properties:
            cancelReason:
              type: string
            deliveryProof:
              type: string
              format: uri
            driverId:
              type: string
              format: uuid

    OrderListResponse:
      type: object
      properties:
        orders:
          type: array
          items:
            $ref: '#/components/schemas/Order'
        pagination:
          $ref: '#/components/schemas/Pagination'

    # Cart
    Cart:
      type: object
      properties:
        id:
          type: string
          format: uuid
        sessionToken:
          type: string
        status:
          type: string
          enum: [active, expired]
        items:
          type: array
          items:
            $ref: '#/components/schemas/CartItem'
        totalItems:
          type: integer
        totalPrice:
          type: number
          format: float
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    CartItem:
      type: object
      properties:
        id:
          type: string
          format: uuid
        productId:
          type: string
          format: uuid
        product:
          $ref: '#/components/schemas/Product'
        quantity:
          type: integer
          minimum: 1
        unitPrice:
          type: number
          format: float
        totalPrice:
          type: number
          format: float
        notes:
          type: string
          nullable: true

    AddToCartRequest:
      type: object
      required:
        - productId
        - quantity
      properties:
        productId:
          type: string
          format: uuid
        quantity:
          type: integer
          minimum: 1
          maximum: 999
        notes:
          type: string

    UpdateCartItemRequest:
      type: object
      required:
        - quantity
      properties:
        quantity:
          type: integer
          minimum: 1
          maximum: 999
        notes:
          type: string

    # Common
    Pagination:
      type: object
      properties:
        page:
          type: integer
          example: 1
        limit:
          type: integer
          example: 20
        total:
          type: integer
          example: 100
        totalPages:
          type: integer
          example: 5

    Error:
      type: object
      properties:
        code:
          type: string
          example: ERROR_CODE
        message:
          type: string
          example: Human-readable error message
        details:
          type: object
          properties:
            field:
              type: string
            value:
              type: string
            constraint:
              type: string

  responses:
    Unauthorized:
      description: Unauthorized - Invalid or missing authentication token
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            code: UNAUTHORIZED
            message: Authentication required

    Forbidden:
      description: Forbidden - Insufficient permissions
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            code: FORBIDDEN
            message: You do not have permission to perform this action

    NotFound:
      description: Not Found - Resource does not exist
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            code: NOT_FOUND
            message: The requested resource was not found

    BadRequest:
      description: Bad Request - Invalid input
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            code: BAD_REQUEST
            message: Invalid input data

paths:
  # Authentication Endpoints
  /auth/login:
    post:
      tags:
        - Authentication
      summary: User login
      description: Authenticate user and create session
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
      responses:
        '200':
          description: Login successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LoginResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          description: Invalid credentials
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /auth/logout:
    post:
      tags:
        - Authentication
      summary: User logout
      description: End current user session
      responses:
        '200':
          description: Logout successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Logged out successfully
        '401':
          $ref: '#/components/responses/Unauthorized'

  /auth/session:
    get:
      tags:
        - Authentication
      summary: Get current session
      description: Retrieve current user session information
      responses:
        '200':
          description: Session retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Session'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /auth/user:
    get:
      tags:
        - Authentication
      summary: Get current user
      description: Retrieve authenticated user details
      responses:
        '200':
          description: User retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '401':
          $ref: '#/components/responses/Unauthorized'

  # Products Endpoints
  /products:
    get:
      tags:
        - Products
      summary: List products
      description: Get paginated list of products with filters
      parameters:
        - name: page
          in: query
          schema:
            type: integer
            default: 1
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
            maximum: 100
        - name: sortBy
          in: query
          schema:
            type: string
            enum: [name, price, created_at]
            default: created_at
        - name: sortOrder
          in: query
          schema:
            type: string
            enum: [asc, desc]
            default: desc
        - name: categoryId
          in: query
          schema:
            type: string
            format: uuid
        - name: search
          in: query
          schema:
            type: string
        - name: isAvailable
          in: query
          schema:
            type: boolean
        - name: minPrice
          in: query
          schema:
            type: number
            format: float
        - name: maxPrice
          in: query
          schema:
            type: number
            format: float
      responses:
        '200':
          description: Products retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProductListResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'

    post:
      tags:
        - Products
      summary: Create product
      description: Create a new product (Admin only)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateProductRequest'
      responses:
        '201':
          description: Product created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Product'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

  /products/{id}:
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: string
          format: uuid

    get:
      tags:
        - Products
      summary: Get product by ID
      description: Retrieve a specific product
      responses:
        '200':
          description: Product retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Product'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

    put:
      tags:
        - Products
      summary: Update product
      description: Update an existing product (Admin only)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateProductRequest'
      responses:
        '200':
          description: Product updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Product'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

    delete:
      tags:
        - Products
      summary: Delete product
      description: Delete a product (Admin only)
      responses:
        '200':
          description: Product deleted
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Product deleted successfully
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

  # Orders Endpoints
  /orders:
    get:
      tags:
        - Orders
      summary: List orders
      description: Get paginated list of orders with role-based filtering
      parameters:
        - name: page
          in: query
          schema:
            type: integer
            default: 1
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
        - name: status
          in: query
          schema:
            type: array
            items:
              type: string
              enum: [pending, confirmed, priced, assigned, picked_up, in_transit, delivered, cancelled]
        - name: sortBy
          in: query
          schema:
            type: string
            enum: [created_at, updated_at, total_amount]
            default: created_at
        - name: sortOrder
          in: query
          schema:
            type: string
            enum: [asc, desc]
            default: desc
      responses:
        '200':
          description: Orders retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrderListResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'

    post:
      tags:
        - Orders
      summary: Create order
      description: Create a new order (Restaurant only)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateOrderRequest'
      responses:
        '201':
          description: Order created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Order'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

  /orders/{id}:
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: string
          format: uuid

    get:
      tags:
        - Orders
      summary: Get order by ID
      description: Retrieve a specific order
      responses:
        '200':
          description: Order retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Order'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

  /orders/{id}/status:
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: string
          format: uuid

    patch:
      tags:
        - Orders
      summary: Update order status
      description: Transition order to next status
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateOrderStatusRequest'
      responses:
        '200':
          description: Order status updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Order'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

  # Users Endpoints
  /users/me:
    get:
      tags:
        - Users
      summary: Get current user profile
      description: Retrieve authenticated user's profile
      responses:
        '200':
          description: Profile retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Profile'
        '401':
          $ref: '#/components/responses/Unauthorized'

    put:
      tags:
        - Users
      summary: Update own profile
      description: Update authenticated user's profile
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                fullName:
                  type: string
                phone:
                  type: string
                address:
                  type: string
                city:
                  type: string
                postalCode:
                  type: string
      responses:
        '200':
          description: Profile updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Profile'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /users/{id}:
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: string
          format: uuid

    get:
      tags:
        - Users
      summary: Get user by ID
      description: Retrieve specific user profile (Admin only or own profile)
      responses:
        '200':
          description: Profile retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Profile'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

  /users/drivers/available:
    get:
      tags:
        - Users
      summary: List available drivers
      description: Get list of available drivers (Admin/Restaurant only)
      parameters:
        - name: lat
          in: query
          schema:
            type: number
            format: float
        - name: lng
          in: query
          schema:
            type: number
            format: float
        - name: maxDistance
          in: query
          schema:
            type: number
            format: float
            default: 10
        - name: vehicleType
          in: query
          schema:
            type: string
      responses:
        '200':
          description: Drivers retrieved
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Profile'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

  # Cart Endpoints
  /cart:
    get:
      tags:
        - Cart
      summary: Get cart
      description: Retrieve current user's cart
      responses:
        '200':
          description: Cart retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Cart'
        '401':
          $ref: '#/components/responses/Unauthorized'

    delete:
      tags:
        - Cart
      summary: Clear cart
      description: Remove all items from cart
      responses:
        '200':
          description: Cart cleared
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Cart cleared successfully
        '401':
          $ref: '#/components/responses/Unauthorized'

  /cart/items:
    post:
      tags:
        - Cart
      summary: Add item to cart
      description: Add a product to the cart
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AddToCartRequest'
      responses:
        '201':
          description: Item added to cart
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CartItem'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          description: Product not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /cart/items/{id}:
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: string
          format: uuid

    put:
      tags:
        - Cart
      summary: Update cart item
      description: Update quantity or notes of cart item
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateCartItemRequest'
      responses:
        '200':
          description: Cart item updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CartItem'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

    delete:
      tags:
        - Cart
      summary: Remove cart item
      description: Remove item from cart
      responses:
        '200':
          description: Item removed
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Item removed from cart
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
