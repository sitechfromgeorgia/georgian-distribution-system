# RLS Policies Documentation

## Overview

This directory contains comprehensive documentation for the Row Level Security (RLS) policies implemented in the Georgian Distribution System. The policies provide role-based access control with sophisticated business logic validation.

## Structure

```
supabase/policies/
â”œâ”€â”€ README.md                           # This file - main documentation
â”œâ”€â”€ roles/                              # Role-specific documentation
â”‚   â”œâ”€â”€ admin-policies.md              # Admin role policies
â”‚   â”œâ”€â”€ restaurant-policies.md         # Restaurant role policies
â”‚   â”œâ”€â”€ driver-policies.md             # Driver role policies
â”‚   â””â”€â”€ demo-policies.md               # Demo role policies
â”œâ”€â”€ tables/                             # Table-specific policies
â”‚   â”œâ”€â”€ profiles-policies.md           # Profiles table policies
â”‚   â”œâ”€â”€ products-policies.md           # Products table policies
â”‚   â”œâ”€â”€ orders-policies.md             # Orders table policies
â”‚   â”œâ”€â”€ order-items-policies.md        # Order items table policies
â”‚   â”œâ”€â”€ notifications-policies.md      # Notifications table policies
â”‚   â””â”€â”€ demo-sessions-policies.md      # Demo sessions table policies
â”œâ”€â”€ business-logic/                     # Business logic policies
â”‚   â”œâ”€â”€ order-workflow-policies.md     # Order workflow policies
â”‚   â”œâ”€â”€ inventory-policies.md          # Inventory management policies
â”‚   â””â”€â”€ notification-policies.md       # Notification delivery policies
â”œâ”€â”€ testing/                            # Policy testing documentation
â”‚   â”œâ”€â”€ test-scenarios.md              # Test scenarios for each role
â”‚   â”œâ”€â”€ validation-scripts.md          # Automated validation scripts
â”‚   â””â”€â”€ troubleshooting.md             # Common issues and solutions
â””â”€â”€ migration/                          # Migration documentation
    â”œâ”€â”€ migration-guide.md             # How to apply RLS policies
    â””â”€â”€ rollback-procedures.md         # How to rollback if needed
```

## Key Features

### ðŸ”’ Security
- **Role-based access control** (admin, restaurant, driver, demo)
- **Data isolation** between roles
- **Business logic enforcement** at database level
- **Audit logging** for policy violations

### ðŸŽ¯ Business Logic
- **Order workflow validation** with status progression rules
- **Inventory management** with stock level enforcement
- **Driver assignment** with capacity validation
- **Demo session limitations** for testing purposes

### ðŸ“Š Monitoring
- **Policy violation logging** in `policy_audit_log` table
- **Performance tracking** for policy execution
- **Access pattern analysis** for security insights

## Quick Start

1. **Apply the migration:**
   ```bash
   supabase db push
   ```

2. **Test policies:**
   ```bash
   # Run policy validation
   supabase functions deploy admin-validate-rls
   ```

3. **Monitor policy violations:**
   ```sql
   SELECT * FROM policy_audit_log WHERE allowed = false;
   ```

## Policy Hierarchy

```
Admin (Full Access)
â”œâ”€â”€ Restaurant (Business Operations)
â”‚   â”œâ”€â”€ Driver (Order Fulfillment)
â”‚   â””â”€â”€ Demo (Limited Testing)
â””â”€â”€ System Functions
```

## Common Use Cases

### Restaurant Operations
- Create and manage orders
- Update order status
- Manage product inventory
- View order history

### Driver Operations
- View assigned orders
- Update delivery status
- Accept pending orders
- Track delivery progress

### Admin Operations
- Full system access
- User management
- Policy oversight
- System monitoring

### Demo Operations
- Limited read-only access
- Time-restricted sessions
- Data isolation
- Testing safeguards

## Policy Validation

All policies are validated through:

1. **Automated testing** with role-specific test cases
2. **Manual verification** of business logic
3. **Audit log monitoring** for violations
4. **Performance optimization** reviews

## Support

For questions or issues:
1. Check the `testing/` directory for common solutions
2. Review the specific role or table documentation
3. Examine the audit logs for violation patterns
4. Contact the system administrator

---

**Last Updated:** November 4, 2025  
**Version:** 1.0  
**System:** Georgian Distribution System