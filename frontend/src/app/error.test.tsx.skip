/**
 * Root Error Boundary Tests
 *
 * Tests for the root error boundary component that catches
 * unhandled errors and displays user-friendly error pages.
 */

import { describe, it, expect, vi, beforeEach } from 'vitest'
import { render, screen, fireEvent } from '@testing-library/react'
import * as React from 'react'
import Error from './error'

// Mock the logger
vi.mock('@/lib/logger', () => ({
  logger: {
    error: vi.fn(),
  },
}))

// Mock lucide-react icons
vi.mock('lucide-react', () => ({
  AlertTriangle: () => React.createElement('div', { 'data-testid': 'alert-icon' }, 'Alert'),
  Home: () => React.createElement('div', { 'data-testid': 'home-icon' }, 'Home'),
  RefreshCw: () => React.createElement('div', { 'data-testid': 'refresh-icon' }, 'Refresh'),
}))

// Mock UI components
vi.mock('@/components/ui/button', () => ({
  Button: ({ children, onClick, ...props }: any) =>
    React.createElement('button', { onClick, ...props }, children),
}))

vi.mock('@/components/ui/card', () => ({
  Card: ({ children, ...props }: any) => React.createElement('div', props, children),
  CardHeader: ({ children, ...props }: any) => React.createElement('div', props, children),
  CardTitle: ({ children, ...props }: any) => React.createElement('h2', props, children),
  CardDescription: ({ children, ...props }: any) => React.createElement('p', props, children),
  CardContent: ({ children, ...props }: any) => React.createElement('div', props, children),
  CardFooter: ({ children, ...props }: any) => React.createElement('div', props, children),
}))

describe('Error Boundary', () => {
  const mockReset = vi.fn()
  const mockError = new Error('Test error message')

  beforeEach(() => {
    vi.clearAllMocks()
    // Mock window.location
    Object.defineProperty(window, 'location', {
      value: { pathname: '/test', href: '/' },
      writable: true,
    })
  })

  it('should render error boundary with error message in development', () => {
    // Arrange
    const originalEnv = process.env.NODE_ENV
    process.env.NODE_ENV = 'development'

    // Act
    render(<Error error={mockError} reset={mockReset} />)

    // Assert
    expect(screen.getByText('რაღაც შეცდომა მოხდა')).toBeInTheDocument()
    expect(screen.getByText('Test error message')).toBeInTheDocument()

    // Cleanup
    process.env.NODE_ENV = originalEnv
  })

  it('should not show error details in production', () => {
    // Arrange
    const originalEnv = process.env.NODE_ENV
    process.env.NODE_ENV = 'production'

    // Act
    render(<Error error={mockError} reset={mockReset} />)

    // Assert
    expect(screen.getByText('რაღაც შეცდომა მოხდა')).toBeInTheDocument()
    expect(screen.queryByText('Test error message')).not.toBeInTheDocument()

    // Cleanup
    process.env.NODE_ENV = originalEnv
  })

  it('should display error digest if available in development', () => {
    // Arrange
    const originalEnv = process.env.NODE_ENV
    process.env.NODE_ENV = 'development'
    const errorWithDigest = Object.assign(new Error('Test'), { digest: 'abc123' })

    // Act
    render(<Error error={errorWithDigest} reset={mockReset} />)

    // Assert
    expect(screen.getByText(/Error ID: abc123/)).toBeInTheDocument()

    // Cleanup
    process.env.NODE_ENV = originalEnv
  })

  it('should call reset function when "სცადე თავიდან" button is clicked', () => {
    // Act
    render(<Error error={mockError} reset={mockReset} />)
    const resetButton = screen.getByText('სცადე თავიდან')
    fireEvent.click(resetButton)

    // Assert
    expect(mockReset).toHaveBeenCalledTimes(1)
  })

  it('should navigate to home when "მთავარი გვერდი" button is clicked', () => {
    // Act
    render(<Error error={mockError} reset={mockReset} />)
    const homeButton = screen.getByText('მთავარი გვერდი')
    fireEvent.click(homeButton)

    // Assert
    expect(window.location.href).toBe('/')
  })

  it('should render alert icon', () => {
    // Act
    render(<Error error={mockError} reset={mockReset} />)

    // Assert
    expect(screen.getByTestId('alert-icon')).toBeInTheDocument()
  })

  it('should render both action buttons', () => {
    // Act
    render(<Error error={mockError} reset={mockReset} />)

    // Assert
    expect(screen.getByTestId('refresh-icon')).toBeInTheDocument()
    expect(screen.getByTestId('home-icon')).toBeInTheDocument()
  })

  it('should display Georgian error message', () => {
    // Act
    render(<Error error={mockError} reset={mockReset} />)

    // Assert
    expect(screen.getByText('ბოდიში, მოხდა მოულოდნელი შეცდომა. გთხოვთ, სცადოთ თავიდან.')).toBeInTheDocument()
  })
})
